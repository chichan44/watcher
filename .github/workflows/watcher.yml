name: Frame Comment Watcher

on:
  workflow_dispatch: {}

concurrency:
  group: watcher
  cancel-in-progress: true

permissions:
  contents: write
  actions: write

env:
  POSTER_REPO: chichan44/framebot
  POSTER_BRANCH: main
  PYTHON_VERSION: "3.10"

jobs:
  run-watcher:
    runs-on: ubuntu-latest

    # Map secrets to env once here; then use env.* everywhere (including if:)
    env:
      FACEBOOK_PAGE_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
      FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
      TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
      TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
      TG_NOTIFY_TOKEN: ${{ secrets.TELEGRAM_NOTIFY_BOT_TOKEN }}
      TG_NOTIFY_CHAT: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID }}

    steps:
      - name: Checkout poster repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.POSTER_REPO }}
          ref: ${{ env.POSTER_BRANCH }}
          token: ${{ secrets.POSTER_REPO_TOKEN }}
          path: poster
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('poster/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r poster/requirements.txt

      - name: Prepare config.yaml
        run: |
          cp poster/config_template.yaml poster/config.yaml
          python - <<'PY'
          import yaml, os
          p = 'poster/config.yaml'
          with open(p,'r',encoding='utf-8') as f:
              c = yaml.safe_load(f)
          c['platforms']['facebook']['page_access_token'] = os.environ['FACEBOOK_PAGE_TOKEN']
          c['platforms']['facebook']['page_id'] = os.environ['FACEBOOK_PAGE_ID']
          c['platforms']['telegram']['bot_token'] = os.environ['TELEGRAM_BOT_TOKEN']
          c['platforms']['telegram']['channel_id'] = os.environ['TELEGRAM_CHANNEL_ID']
          if 'comments' in c and isinstance(c['comments'], dict):
              c['comments']['watcher_enabled'] = True
          with open(p,'w',encoding='utf-8') as f:
              yaml.safe_dump(c, f, sort_keys=False)
          PY

      - name: Configure Git identity
        run: |
          git config --global user.name "watcher-bot"
          git config --global user.email "watcher@users.noreply.github.com"

      - name: Notify start (Telegram, optional)
        if: ${{ env.TG_NOTIFY_TOKEN != '' && env.TG_NOTIFY_CHAT != '' }}
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${TG_NOTIFY_TOKEN}/sendMessage" \
            -d chat_id="${TG_NOTIFY_CHAT}" \
            -d parse_mode="Markdown" \
            -d text="Watcher started for \`${{ env.POSTER_REPO }}\` on \`${{ env.POSTER_BRANCH }}\`. Running ~4h loop."

      - name: Watch loop (4 hours total)
        shell: bash
        working-directory: poster
        env:
          FACEBOOK_PAGE_TOKEN: ${{ env.FACEBOOK_PAGE_TOKEN }}
          FACEBOOK_PAGE_ID: ${{ env.FACEBOOK_PAGE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ env.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ env.TELEGRAM_CHANNEL_ID }}
          TG_NOTIFY_TOKEN: ${{ env.TG_NOTIFY_TOKEN }}
          TG_NOTIFY_CHAT: ${{ env.TG_NOTIFY_CHAT }}
        run: |
          set -e
          start_ts=$(date +%s)
          end_ts=$(( start_ts + 4*60*60 ))
          SLEEP_SECONDS=5
          i=0
          while [ "$(date +%s)" -lt "$end_ts" ]; do
            i=$((i+1))
            echo "[$i] Pulling latest poster repo..."
            git pull --ff-only || true

            echo "Running watcher-only..."
            python github_action_poster.py --config config.yaml --watcher-only || code=$?
            code=${code:-0}
            if [ $code -ne 0 ] && [ -n "$TG_NOTIFY_TOKEN" ] && [ -n "$TG_NOTIFY_CHAT" ]; then
              curl -s -X POST \
                "https://api.telegram.org/bot${TG_NOTIFY_TOKEN}/sendMessage" \
                -d chat_id="${TG_NOTIFY_CHAT}" \
                -d parse_mode="Markdown" \
                -d text="Watcher error on iteration *$i* (exit $code) for \`${{ env.POSTER_REPO }}\`."
            fi

            echo "Committing state if changed (root or data/)..."
            # Rebase to reduce non-fast-forward conflicts with hourly poster workflow
            git pull --rebase || true
            # Stage only files that exist to avoid pathspec fatal errors
            test -f bot_state.json && git add bot_state.json || true
            test -f data/bot_state.json && git add data/bot_state.json || true
            if ! git diff --staged --quiet; then
              git commit -m "watcher: update bot state [skip ci]" || true
              # Push; on failure (race), rebase and retry once
              git push origin HEAD:${{ env.POSTER_BRANCH }} || (git pull --rebase || true; git push origin HEAD:${{ env.POSTER_BRANCH }} || true)
            fi

            sleep "$SLEEP_SECONDS"
          done

      - name: Notify stop (Telegram, optional)
        if: ${{ env.TG_NOTIFY_TOKEN != '' && env.TG_NOTIFY_CHAT != '' }}
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${TG_NOTIFY_TOKEN}/sendMessage" \
            -d chat_id="${TG_NOTIFY_CHAT}" \
            -d parse_mode="Markdown" \
            -d text="Watcher finished 4h loop for \`${{ env.POSTER_REPO }}\`. Will restart in 2 minutes."

      - name: Wait 2 minutes before restart
        run: sleep 120

      - name: Self-restart workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/watcher.yml/dispatches" \
            -d '{"ref":"'"${{ github.ref_name }}"'"}'
