name: Frame Comment Watcher

on:
  # Start manually once from the Actions tab; it will self-restart indefinitely
  workflow_dispatch: {}

concurrency:
  group: watcher
  cancel-in-progress: true

permissions:
  contents: write     # push bot_state.json back to poster repo
  actions: write      # self-dispatch to restart after 4h+2m

env:
  POSTER_REPO: chichan44/framebot
  POSTER_BRANCH: main
  PYTHON_VERSION: "3.10"

jobs:
  run-watcher:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout poster repo
        uses: actions/checkout@v4
        with:
          repository: ${{ env.POSTER_REPO }}
          ref: ${{ env.POSTER_BRANCH }}
          token: ${{ secrets.POSTER_REPO_TOKEN }}
          path: poster
          fetch-depth: 1

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Cache pip
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-${{ hashFiles('poster/requirements.txt') }}
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r poster/requirements.txt

      - name: Prepare config.yaml
        run: |
          cp poster/config_template.yaml poster/config.yaml
          python - <<'PY'
          import yaml, os
          p = 'poster/config.yaml'
          with open(p,'r',encoding='utf-8') as f:
              c = yaml.safe_load(f)
          # Inject platform tokens from secrets (used by poster code)
          c['platforms']['facebook']['page_access_token'] = os.environ['FACEBOOK_PAGE_TOKEN']
          c['platforms']['facebook']['page_id'] = os.environ['FACEBOOK_PAGE_ID']
          c['platforms']['telegram']['bot_token'] = os.environ['TELEGRAM_BOT_TOKEN']
          c['platforms']['telegram']['channel_id'] = os.environ['TELEGRAM_CHANNEL_ID']
          # Ensure comment watcher is enabled if present in config
          if 'comments' in c and isinstance(c['comments'], dict):
              c['comments']['watcher_enabled'] = True
          with open(p,'w',encoding='utf-8') as f:
              yaml.safe_dump(c, f, sort_keys=False)
          PY
        env:
          FACEBOOK_PAGE_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}

      - name: Configure Git identity (for pushing state)
        run: |
          git config --global user.name "watcher-bot"
          git config --global user.email "watcher@users.noreply.github.com"

      - name: Notify start (Telegram, optional)
        if: ${{ secrets.TELEGRAM_NOTIFY_BOT_TOKEN != '' && secrets.TELEGRAM_NOTIFY_CHAT_ID != '' }}
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_NOTIFY_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_NOTIFY_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="Watcher started for \`${{ env.POSTER_REPO }}\` on branch \`${{ env.POSTER_BRANCH }}\`. Running ~4h loop."

      - name: Watch loop (4 hours total)
        shell: bash
        env:
          FACEBOOK_PAGE_TOKEN: ${{ secrets.FACEBOOK_PAGE_TOKEN }}
          FACEBOOK_PAGE_ID: ${{ secrets.FACEBOOK_PAGE_ID }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHANNEL_ID: ${{ secrets.TELEGRAM_CHANNEL_ID }}
          TG_NOTIFY_TOKEN: ${{ secrets.TELEGRAM_NOTIFY_BOT_TOKEN }}
          TG_NOTIFY_CHAT: ${{ secrets.TELEGRAM_NOTIFY_CHAT_ID }}
        run: |
          set -e
          iters=120   # 120 * 120s = ~4 hours
          for i in $(seq 1 $iters); do
            echo "[$i/$iters] Pulling latest poster repo..."
            git -C poster pull --ff-only || true

            echo "Running watcher-only..."
            python poster/github_action_poster.py --config poster/config.yaml --watcher-only
            code=$?
            if [ $code -ne 0 ]; then
              echo "watcher-only exited with code $code"
              if [ -n "$TG_NOTIFY_TOKEN" ] && [ -n "$TG_NOTIFY_CHAT" ]; then
                curl -s -X POST \
                  "https://api.telegram.org/bot${TG_NOTIFY_TOKEN}/sendMessage" \
                  -d chat_id="${TG_NOTIFY_CHAT}" \
                  -d parse_mode="Markdown" \
                  -d text="Watcher error on iteration *$i* (exit $code) for \`${{ env.POSTER_REPO }}\`."
              fi
            fi

            echo "Committing bot_state.json if changed..."
            git -C poster add bot_state.json || true
            if ! git -C poster diff --staged --quiet; then
              git -C poster commit -m "watcher: update bot state [skip ci]" || true
              git -C poster push origin HEAD:${{ env.POSTER_BRANCH }} || true
            fi

            echo "Sleeping 120s..."
            sleep 120
          done

      - name: Notify stop (Telegram, optional)
        if: ${{ secrets.TELEGRAM_NOTIFY_BOT_TOKEN != '' && secrets.TELEGRAM_NOTIFY_CHAT_ID != '' }}
        run: |
          curl -s -X POST \
            "https://api.telegram.org/bot${{ secrets.TELEGRAM_NOTIFY_BOT_TOKEN }}/sendMessage" \
            -d chat_id="${{ secrets.TELEGRAM_NOTIFY_CHAT_ID }}" \
            -d parse_mode="Markdown" \
            -d text="Watcher finished 4h loop for \`${{ env.POSTER_REPO }}\`. Will restart in 2 minutes."

      - name: Wait 2 minutes before restart
        run: sleep 120

      - name: Self-restart workflow
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          curl -s -X POST \
            -H "Authorization: Bearer ${GH_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/actions/workflows/watcher.yml/dispatches" \
            -d '{"ref":"'"${{ github.ref_name }}"'"}'